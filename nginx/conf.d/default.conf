# ═══════════════════════════════════════════════════════
#  HTTP → HTTPS Redirect (all domains)
# ═══════════════════════════════════════════════════════
server {
    listen 80;
    listen [::]:80;
    server_name _;

    # Let's Encrypt challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect everything else to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# ═══════════════════════════════════════════════════════
#  Main Frontend — shotlin.com / www.shotlin.com
# ═══════════════════════════════════════════════════════
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name shotlin.com www.shotlin.com;

    # ─── SSL ───
    ssl_certificate     /etc/letsencrypt/live/shotlin.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/shotlin.com/privkey.pem;
    include             /etc/nginx/conf.d/ssl-params.conf;

    # ─── Security Headers ───
    include /etc/nginx/conf.d/security-headers.conf;

    # ─── Rate Limiting ───
    limit_req zone=general burst=50 nodelay;
    limit_conn addr 50;

    # ─── Proxy to Frontend ───
    location / {
        proxy_pass http://frontend;
        include /etc/nginx/conf.d/proxy-params.conf;
    }

    # ─── Static assets — long cache ───
    location /_next/static/ {
        proxy_pass http://frontend;
        include /etc/nginx/conf.d/proxy-params.conf;
        expires 365d;
        add_header Cache-Control "public, immutable";
    }

    # Block sensitive paths
    location ~ /\. {
        deny all;
    }
}

# ═══════════════════════════════════════════════════════
#  API Backend — api.shotlin.com
# ═══════════════════════════════════════════════════════
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.shotlin.com;

    # ─── SSL ───
    ssl_certificate     /etc/letsencrypt/live/shotlin.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/shotlin.com/privkey.pem;
    include             /etc/nginx/conf.d/ssl-params.conf;

    # ─── Security Headers ───
    include /etc/nginx/conf.d/security-headers.conf;

    # ─── API Rate Limiting ───
    limit_req zone=api burst=20 nodelay;
    limit_conn addr 30;

    # ─── Login Rate Limiting (stricter) ───
    location /api/v1/auth/login {
        limit_req zone=login burst=3 nodelay;
        proxy_pass http://backend;
        include /etc/nginx/conf.d/proxy-params.conf;
    }

    # ─── Proxy to Backend API ───
    location / {
        proxy_pass http://backend;
        include /etc/nginx/conf.d/proxy-params.conf;
    }

    # ─── Uploads with caching ───
    location /uploads/ {
        proxy_pass http://backend;
        include /etc/nginx/conf.d/proxy-params.conf;
        expires 30d;
        add_header Cache-Control "public";
    }

    # Block sensitive paths
    location ~ /\. {
        deny all;
    }
}

# ═══════════════════════════════════════════════════════
#  Dashboard / CRM — crm.shotlin.com
# ═══════════════════════════════════════════════════════
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name crm.shotlin.com;

    # ─── SSL ───
    ssl_certificate     /etc/letsencrypt/live/shotlin.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/shotlin.com/privkey.pem;
    include             /etc/nginx/conf.d/ssl-params.conf;

    # ─── Security Headers ───
    include /etc/nginx/conf.d/security-headers.conf;

    # ─── Rate Limiting ───
    limit_req zone=general burst=30 nodelay;
    limit_conn addr 30;

    # ─── Proxy to Dashboard ───
    location / {
        proxy_pass http://dashboard;
        include /etc/nginx/conf.d/proxy-params.conf;
    }

    # ─── Static assets — long cache ───
    location /_next/static/ {
        proxy_pass http://dashboard;
        include /etc/nginx/conf.d/proxy-params.conf;
        expires 365d;
        add_header Cache-Control "public, immutable";
    }

    # Block sensitive paths
    location ~ /\. {
        deny all;
    }
}

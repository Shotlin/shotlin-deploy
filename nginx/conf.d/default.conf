# ═══════════════════════════════════════════════════════
#  Default Server — Drop ALL unknown host requests
# ═══════════════════════════════════════════════════════
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    listen 443 ssl default_server;
    listen [::]:443 ssl default_server;
    server_name _;

    ssl_certificate     /etc/nginx/ssl/origin.pem;
    ssl_certificate_key /etc/nginx/ssl/origin-key.pem;

    # Drop connection immediately
    return 444;
}

# ═══════════════════════════════════════════════════════
#  HTTP → HTTPS Redirect
# ═══════════════════════════════════════════════════════
server {
    listen 80;
    listen [::]:80;
    server_name shotlin.com www.shotlin.com api.shotlin.com adminpanel.shotlin.com;

    location / {
        return 301 https://$host$request_uri;
    }
}

# ═══════════════════════════════════════════════════════
#  Frontend Website — shotlin.com / www.shotlin.com
# ═══════════════════════════════════════════════════════
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name shotlin.com www.shotlin.com;

    # ─── Cloudflare Origin SSL ───
    ssl_certificate     /etc/nginx/ssl/origin.pem;
    ssl_certificate_key /etc/nginx/ssl/origin-key.pem;
    include             /etc/nginx/conf.d/ssl-params.conf;

    # ─── Security ───
    include /etc/nginx/conf.d/security-headers.conf;

    # Block bad bots
    if ($bad_bot) {
        return 444;
    }

    # ─── Rate Limiting ───
    limit_req zone=general burst=50 nodelay;
    limit_conn addr 50;

    # ─── Proxy to Frontend ───
    location / {
        proxy_pass http://frontend;
        include /etc/nginx/conf.d/proxy-params.conf;
        proxy_cache_bypass $http_upgrade;
    }

    # ─── Next.js Static Assets — aggressive caching ───
    location /_next/static/ {
        proxy_pass http://frontend;
        include /etc/nginx/conf.d/proxy-params.conf;
        expires 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }

    # ─── Public static files ───
    location ~* \.(ico|png|jpg|jpeg|gif|svg|webp|avif|woff|woff2|ttf|otf|css|js)$ {
        proxy_pass http://frontend;
        include /etc/nginx/conf.d/proxy-params.conf;
        expires 30d;
        add_header Cache-Control "public";
        access_log off;
    }

    # Block hidden files
    location ~ /\. {
        deny all;
        return 404;
    }

    # Block common attack paths
    location ~* /(wp-admin|wp-login|xmlrpc|phpmyadmin|.env|.git|.svn) {
        deny all;
        return 404;
    }
}

# ═══════════════════════════════════════════════════════
#  API Backend — api.shotlin.com
# ═══════════════════════════════════════════════════════
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.shotlin.com;

    # ─── Cloudflare Origin SSL ───
    ssl_certificate     /etc/nginx/ssl/origin.pem;
    ssl_certificate_key /etc/nginx/ssl/origin-key.pem;
    include             /etc/nginx/conf.d/ssl-params.conf;

    # ─── Security ───
    include /etc/nginx/conf.d/security-headers.conf;

    # ─── Login — Ultra-strict rate limiting ───
    location /api/v1/auth/login {
        limit_req zone=login burst=3 nodelay;
        limit_conn addr 5;
        client_max_body_size 1k;

        if ($bad_bot) {
            return 444;
        }

        proxy_pass http://backend;
        include /etc/nginx/conf.d/proxy-params.conf;
    }

    # ─── Auth routes — strict ───
    location /api/v1/auth/ {
        limit_req zone=api burst=10 nodelay;
        limit_conn addr 10;
        client_max_body_size 4k;

        proxy_pass http://backend;
        include /etc/nginx/conf.d/proxy-params.conf;
    }

    # ─── Upload route — larger body ───
    location /api/v1/upload {
        limit_req zone=api burst=5 nodelay;
        limit_conn addr 5;
        client_max_body_size 10M;

        proxy_pass http://backend;
        include /etc/nginx/conf.d/proxy-params.conf;
    }

    # ─── General API — standard rate limit ───
    location /api/ {
        limit_req zone=api burst=20 nodelay;
        limit_conn addr 30;
        client_max_body_size 1M;

        if ($bad_bot) {
            return 444;
        }

        proxy_pass http://backend;
        include /etc/nginx/conf.d/proxy-params.conf;
    }

    # ─── Health check (no rate limit) ───
    location = / {
        proxy_pass http://backend;
        include /etc/nginx/conf.d/proxy-params.conf;
        access_log off;
    }

    # ─── Uploads with caching ───
    location /uploads/ {
        proxy_pass http://backend;
        include /etc/nginx/conf.d/proxy-params.conf;
        expires 30d;
        add_header Cache-Control "public";
        access_log off;
    }

    # Block everything else
    location ~ /\. {
        deny all;
        return 404;
    }

    location ~* /(wp-admin|wp-login|xmlrpc|phpmyadmin|.env|.git|.svn) {
        deny all;
        return 404;
    }
}

# ═══════════════════════════════════════════════════════
#  Admin Panel / Dashboard — adminpanel.shotlin.com
# ═══════════════════════════════════════════════════════
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name adminpanel.shotlin.com;

    # ─── Cloudflare Origin SSL ───
    ssl_certificate     /etc/nginx/ssl/origin.pem;
    ssl_certificate_key /etc/nginx/ssl/origin-key.pem;
    include             /etc/nginx/conf.d/ssl-params.conf;

    # ─── Security ───
    include /etc/nginx/conf.d/security-headers.conf;

    # Block bad bots entirely on admin panel
    if ($bad_bot) {
        return 444;
    }

    # ─── Rate Limiting (stricter for admin) ───
    limit_req zone=general burst=20 nodelay;
    limit_conn addr 20;

    # ─── Proxy to Dashboard ───
    location / {
        proxy_pass http://dashboard;
        include /etc/nginx/conf.d/proxy-params.conf;
    }

    # ─── Next.js Static Assets ───
    location /_next/static/ {
        proxy_pass http://dashboard;
        include /etc/nginx/conf.d/proxy-params.conf;
        expires 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }

    # Block hidden files and attack paths
    location ~ /\. {
        deny all;
        return 404;
    }

    location ~* /(wp-admin|wp-login|xmlrpc|phpmyadmin|.env|.git|.svn) {
        deny all;
        return 404;
    }
}
